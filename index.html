<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Hopfield NN: Training Data</title>
	<link rel="stylesheet" type="text/css" href="./node_modules/bulma/css/bulma.css">
	<link rel="stylesheet" type="text/css" href="./css/app.css">
	<link href="https://use.fontawesome.com/releases/v5.0.2/css/all.css" rel="stylesheet">
</head>
<body>
	<section class="section">
		<div class="columns">
			<div class="column is-3">
				<nav class="panel">
				  <p class="panel-heading">
				    Hopfield Neural Network 
				  </p>
				  <p class="panel-tabs">
				    <a class="is-active">Train & Testing</a>
				    <a>Summary</a>
				    <a>About</a>
				    <a>Github</a>
				  </p>
				  <div id="menu">
					  <div class="panel-block">
					  	<div>
					  		<h1 class="is-size-6">Canny Params</h1>
					  		<div class="field is-horizontal">
						  		<div class="control has-rig">
							  		<small>Sigma</small>
							  		<input class="input" type="number" name="sigma" value="1.2">
							  	</div>
							  	<div class="control has-rig">
							  		<small>Ht</small>
							  		<input class="input" type="number" name="ht" value="30">
							  	</div>
							  	<div class="control has-rig">
							  		<small>Lt</small>
							  		<input class="input" type="number" name="lt" value="10">
							  	</div>
							  	<div class="control has-rig">
							  		<small>Kernel</small>
							  		<input class="input" type="number" name="kernel" value="3">
							  	</div>
						  	</div>
					  	</div>
					  </div>
					  <div class="panel-block">
				    	<div class="field is-fullwidth" style="width: 100%">
				    		<div class="file has-name is-small is-primary is-boxed is-fullwidth">
							  <label class="file-label">
							    <input class="file-input" type="file" accept="image/*" name="image">
							    <span class="file-cta is-warning">
							      <span class="file-icon">
							        <i class="fa fa-file-image"></i>
							      </span>
							      <span class="file-label has-text-centered">
							        Load Image
							      </span>
							    </span>
							    <span class="file-name">
							      File Name
							    </span>
							  </label>
							</div>
				    	</div>
					  </div>
					  <div class="panel-block">
					  	<div class="control">
					  		<label>Recognize as: </label>
					  		<input type="text" class="input" name="nama_sayur" placeholder="ex: wortel">
					  	</div>
					  	<div>
					  	</div>
					  </div>
					  <div class="panel-block">
					  	<button class="is-fullwidth button is-dark" id="train_button">
					  		Train Data
					  	</button>
					  </div>
					  <div class="panel-block">
					  	<button class="is-fullwidth button is-dark" id="draw">
					  		Test Data
					  	</button>
					  </div>
					  <div class="panel-block">
					  	<button class="is-fullwidth button is-dark" id="clearData">
					  		Clear Output View
					  	</button>
					  </div>
					   <div class="panel-block">
					  	<button class="is-fullwidth button is-dark" id="resetNetwork">
					  		Reset Network
					  	</button>
					  </div>
					  <div class="panel-block">
					  	<div class="field has-text-centered">
					  		<div class="file">
							  <label class="file-label">
							    <input class="file-input is-fullwidth" type="file" name="importSaveData">
							    <span class="file-cta">
							      <span class="file-label">
							        Import Data
							      </span>
							    </span>
							  </label>
							</div>
					  	</div>
					  </div>
					  <div class="panel-block">
					  	<button class="is-fullwidth button is-dark" id="saveData">
					  		Export Data
					  	</button>
					  </div>
				  </div>
				</nav>
			</div>
			<div class="column is-9">
				<div class="my-box">
					<h1 class="title is-size-5">Preprocessing Image</h1>
					<div class="has-text-centered my-box" style="margin-bottom: 50px">
						<img id="imgCitraAsli" src="./static/icon/fileImage.png" width="200px" height="200px">
						<br>
						<h1>Citra Asli</h1>
					</div>
					<div class="columns">
						<div class="column has-text-centered">
							<canvas class="canvas" id="citraScale" width="80" height="80"></canvas>
							<h1>Citra Scale (80 x 80)</h1>	
						</div>
						<div class="column has-text-centered">
							<canvas class="canvas" id="citraAbu" width="80" height="80"></canvas>
							<h1>Canny ED (80 x 80)</h1>	
						</div>
						<div class="column has-text-centered">
							<canvas class="canvas" id="citraBiner" width="76" height="76"></canvas>
							<h1 >Citra Invert (76 x 76)</h1>	
						</div>
						<div class="column has-text-centered">
							<div id="binary" class="is-very-small"></div>
							<h1 style="margin-top: 5px">input array</h1>	
						</div>
						<div class="column has-text-centered">
							<div id="outputData" class="is-very-small"></div>
							<h1 style="margin-top: 5px">recovered pattern</h1>	
						</div>
					</div>
				</div>
				<div class="my-box" style="margin-top:10px">
					<h1 class="title is-size-5">Output Data</h1>
					<div class="my-box">
						<table>
							<tbody>
								<tr>
									<td>Recognized As</td>
									<td> : <b id="labelName"></b></td>
								</tr>
								<tr>
									<td>Recovered pattern </td>
									<td> : <b id="recoveredValue"></b></td>
								</tr>
								<tr>
									<td>Cost ro recover</td>
									<td> : <b id="costToRecover"></b></td>
								</tr>
							</tbody>
						</table>
						<!-- <ul>
							<li>Recognised As : <b id="labelName"></b> </li>
							<li>Recovered pattern : <b id="recoveredValue"></b> </li>
							<li>Cost ro recover : <b id="costToRecover"></b> </li>
						</ul> -->
					</div>
				</div>
			</div>
		</div>
	</section>
	<script type="text/javascript" src="./js/jquery.min.js"></script>
	<script type="text/javascript" src="./js/filesaver.min.js"></script>
	<script type="text/javascript" src="./js/file.js"></script>
	<script type="text/javascript" src="./js/canvas.js"></script>
	<script type="text/javascript" src="./js/processing.js"></script>
	<script type="text/javascript" src="./js/hopfield.js"></script>
	<script type="text/javascript" src="./js/canny.js"></script>
</body>
</html>
<script>
	/*Canvas variable*/
	const citraScale 	= new Canvas(document.getElementById("citraScale"));
	const citraAbu  	= new Canvas(document.getElementById("citraAbu"));
	const citraBiner  	= new Canvas(document.getElementById("citraBiner"));
	var citra = new Image();
	var extractedDataForTrain = [];

	/*init network*/
	var network = new HopfieldNetwork(5776);
	network.initialiseNodes()

	/*do preprocessing*/
	/*function preProcess(citra, treshold) {
		citraScale.drawFromImage(citra, true);
		citraAbu.drawImageByData(grayScale(citraScale.getImageData()));
		citraBiner.drawImageByData(biner(citraAbu.getImageData(), treshold));
		extractedDataForTrain = getBinaryData(citraBiner.getImageData());
		var binaryForPrint = extractedDataForTrain.slice(0);
		$("#binary").empty().append(binaryArrayPrettyPrint(binaryForPrint));
	}*/

	/*do canny edge detection*/
	function do_canny(citra, treshold, ht, lt, sigma, kernel) {
		citraScale.drawFromImage(citra, true);
		const canvas 	= document.getElementById('citraScale');
		const canvasCanny 	= document.getElementById('citraAbu');
		const imageData = CannyJS.canny(canvas, ht, lt, sigma, kernel, "sobel");
		imageData.drawOn(canvasCanny);
		citraBiner.drawImageExcludeBorder(invertColor(citraAbu.getImageData()));
		extractedDataForTrain = getBinaryData(citraBiner.getImageData());
		var binaryForPrint = extractedDataForTrain.slice(0);
		$("#binary").empty().append(binaryArrayPrettyPrint(binaryForPrint));
	}

	/*onchange image event*/
	$("input[name=image]").on("change", function () {
		const treshold 	= $("input[name=tresholdPreprocessing]").val();
		const sigma    	= $("input[name=sigma]").val();
		const ht    	= $("input[name=ht]").val();
		const lt 		= $("input[name=lt]").val();
		const kernel    = $("input[name=kernel]").val();
		$(".file-name").empty().append(this.files[0].name);
		$("input[name=nama_sayur]").val(this.files[0].name.split(".")[0]);
		readURL(this, function (res) {
			citra.onload = function () {
				//preProcess(citra, treshold);
				do_canny(citra, treshold, ht, lt, sigma, kernel);
			}
			$("#imgCitraAsli").attr("src", res.target.result);
			citra.src = res.target.result;
		});
	});

	/*onchange event canny params*/

	$("input[name=sigma]").on("change", function () {
		const treshold 	= $("input[name=tresholdPreprocessing]").val();
		const sigma    	= $("input[name=sigma]").val();
		const ht    	= $("input[name=ht]").val();
		const lt 		= $("input[name=lt]").val();
		const kernel    = $("input[name=kernel]").val();
		do_canny(citra, treshold, ht, lt, sigma, kernel);
	});
	
	$("input[name=ht]").on("change", function () {
		const treshold 	= $("input[name=tresholdPreprocessing]").val();
		const sigma    	= $("input[name=sigma]").val();
		const ht    	= $("input[name=ht]").val();
		const lt 		= $("input[name=lt]").val();
		const kernel    = $("input[name=kernel]").val();
		do_canny(citra, treshold, ht, lt, sigma, kernel);
	});
	
	$("input[name=lt]").on("change", function () {
		const treshold 	= $("input[name=tresholdPreprocessing]").val();
		const sigma    	= $("input[name=sigma]").val();
		const ht    	= $("input[name=ht]").val();
		const lt 		= $("input[name=lt]").val();
		const kernel    = $("input[name=kernel]").val();
		do_canny(citra, treshold, ht, lt, sigma, kernel);
	});

	$("input[name=kernel]").on("change", function () {
		const treshold 	= $("input[name=tresholdPreprocessing]").val();
		const sigma    	= $("input[name=sigma]").val();
		const ht    	= $("input[name=ht]").val();
		const lt 		= $("input[name=lt]").val();
		const kernel    = $("input[name=kernel]").val();
		do_canny(citra, treshold, ht, lt, sigma, kernel);
	});

	/*end of onchage canny params*/

	/*train new pattern*/
	$("#train_button").on("click", function () {
		const label = $("input[name=nama_sayur]").val();
		if (label) {
			network.addPattern(extractedDataForTrain);
			network.convertByCurrentAct(extractedDataForTrain);
			network.pushPatternLabeled(extractedDataForTrain, label);
			alert("trained");
		}else{
			alert("Label belum ditentukan!");
		}
	});

	/*test pattern*/
	$("#draw").on("click", function () {
		if (extractedDataForTrain.length > 0) {
			network.convertByCurrentAct(extractedDataForTrain);
			var outputRecovered = clearArray(network.recover());
			let resultCompared = network.compareOutput(outputRecovered);
			if (!resultCompared) {
				$("#labelName").empty().append("not recognized");
				$("#recoveredValue").empty().append("0 %");
				$("#costToRecover").empty().append(0 + " loop");
			}else{
				$("#labelName").empty().append(resultCompared.label);
				$("#recoveredValue").empty().append((resultCompared.matchValue / resultCompared.totalValue * 100) + '% dari ' + resultCompared.totalValue + " titik berniai 1.");
				$("#costToRecover").empty().append(network.getCost() + " loop");
			}
		}else{
			alert("input data belum dimasukan.");
		}

		$("#outputData").empty().append(binaryArrayPrettyPrint(outputRecovered));
		alert("finished");
	});

	/*clear output*/
	$("#clearData").on("click", function () {
		$('#outputData').empty();
	});

	/*reset Network*/
	$("#resetNetwork").on("click", function () {
		network.initialiseNodes();
		$('#outputData').empty();
		console.log("network reseted");
	});

	/*export data*/
	$("#saveData").on("click", function () {
		const dataToSave = network.saveCurrentData();
		var blob = new Blob([dataToSave], {type: "text/plain;charset=utf-8"});
  		saveAs(blob, "currentState.txt");
	});

	/*import data*/
	$("input[name=importSaveData]").on("change", function() {
		readTxt(this, function(res) {
			const data = JSON.parse(res.target.result);
			network.importData(data.nodes, data.savedPattern);
		})
	});

</script>
